name: Build-Test-Staging-Production

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  # ======================
  # 🏗️ Build Job
  # ======================
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies & Build
        run: |
          npm install
          npm run build || echo "No build script found, skipping build."

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: dist/

  # ======================
  # 🧪 Unit Test Job
  # ======================
  test-unit:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: build-artifact

      - name: Run Unit Tests
        run: |
          echo "Running unit tests..."
          npm test || (echo "❌ Unit tests failed" && exit 1)

  # ======================
  # 🔬 Integration Test Job
  # ======================
  test-integration:
    runs-on: ubuntu-latest
    needs: test-unit
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: build-artifact

      - name: Run Integration Tests
        env:
          TEST_ENV: staging
        run: |
          echo "Running integration tests in $TEST_ENV environment..."
          # 模擬測試通過
          echo "✅ Integration tests passed."

  # ======================
  # 🚀 Deploy to Staging
  # ======================
  deploy-staging:
    runs-on: ubuntu-latest
    needs: test-integration
    environment: staging
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: build-artifact

      - name: Deploy to Staging
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "🚀 Deploying to staging environment..."
          gh release create "staging-$(date +%s)" dist/* --notes "Deployed to staging after passing tests."

  # ======================
  # 🌐 Deploy to Production (Manual Approval)
  # ======================
  deploy-production:
    runs-on: ubuntu-latest
    needs: deploy-staging
    environment:
      name: production
      url: https://github.com/${{ github.repository }}/releases
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: build-artifact

      - name: Deploy to Production
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TEST_ENV: production
        run: |
          echo "🌐 Deploying to production environment..."
          gh release create "prod-$(date +%s)" dist/* --notes "Production release after manual approval."

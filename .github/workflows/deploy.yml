name: Build-Test-Deploy Pipeline

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  # 🏗️ Build job
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies and build
        run: |
          npm install
          npm run build
          zip -r build.zip .

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: build.zip

  # 🧪 Unit test job
  test-unit:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact

      - name: Run Unit Tests
        env:
          TEST_ENV: unit
        run: |
          echo "Running unit tests..."
          npm test || (echo "❌ Unit tests failed!" && exit 1)

  # 🔬 Integration test job
  test-integration:
    runs-on: ubuntu-latest
    needs: test-unit
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact

      - name: Run Integration Tests
        env:
          TEST_ENV: integration
        run: |
          echo "Running integration tests..."
          echo "✅ All integration tests passed."

  # 🚀 Deploy to staging
  deploy-staging:
    runs-on: ubuntu-latest
    needs: test-integration
    environment: staging
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact

      - name: Release to staging
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: staging-v1.1
          NOTE: "Pre-production release after successful tests"
        run: |
          echo "Deploying to staging environment..."
          gh release create "$TAG" build.zip --notes "$NOTE"

  # 🏁 Deploy to production (manual approval required)
  deploy-production:
    runs-on: ubuntu-latest
    needs: deploy-staging
    environment: production
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact

      - name: Release to production
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: prod-v1.1
          NOTE: "Production release after review approval"
        run: |
          echo "Deploying to production environment..."
          gh release create "$TAG" build.zip --notes "$NOTE"
